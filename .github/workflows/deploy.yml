name: Build and Deploy to GitHub Pages

on:
  push:
    branches: [ main ]

permissions:
  contents: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Setup SBT
      uses: sbt/setup-sbt@v1

    - name: Cache SBT
      uses: actions/cache@v4
      with:
        path: |
          ~/.ivy2/cache
          ~/.sbt
          ~/.coursier/cache
        key: ${{ runner.os }}-sbt-${{ hashFiles('**/build.sbt', 'project/**') }}
        restore-keys: |
          ${{ runner.os }}-sbt-

    - name: Compile Scala.js
      run: sbt fastOptJS

    - name: Build Indigo
      run: sbt indigoBuild

    - name: Prepare deployment files
      run: |
        # Store build files
        mkdir -p /tmp/build
        cp -r target/indigoBuild/* /tmp/build/
        
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Switch to gh-pages branch (create if doesn't exist)
        if git ls-remote --exit-code --heads origin gh-pages; then
          git fetch origin gh-pages:gh-pages
          git checkout gh-pages
        else
          git checkout --orphan gh-pages
          git rm -rf . 2>/dev/null || true
        fi
        
        # Remove old main game files (but keep PR directories)
        find . -maxdepth 1 -type f -not -name ".git*" -not -name "pr-*" -delete 2>/dev/null || true
        find . -maxdepth 1 -type d -not -name ".git" -not -name "pr-*" -exec rm -rf {} + 2>/dev/null || true
        
        # Copy new game files to root
        cp -r /tmp/build/* .
        
        # Commit and push
        git add .
        git commit -m "Deploy main game from commit ${{ github.sha }}" || exit 0
        git push origin gh-pages